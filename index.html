<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI NPC Game (Modular)</title>
  <style>
    :root{ --bg:#0b0d10; --panel:#12161b; --muted:#9aa5b1; --text:#e6eef7; --accent:#67c1f5; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text)}
    header{display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;border-bottom:1px solid #1b222b;position:sticky;top:0;background:linear-gradient(180deg,rgba(11,13,16,.97),rgba(11,13,16,.8));backdrop-filter:blur(6px);z-index:10}
    header h1{font-size:1.05rem;margin:0 .25rem 0 0;font-weight:700;letter-spacing:.2px}
    .pill{padding:.25rem .5rem;border-radius:999px;background:#0f141a;border:1px solid #1d2631;color:var(--muted);font-size:.85rem}
    .layout{display:grid;grid-template-columns:260px 1fr 360px;gap:12px;padding:12px}
    .card{background:var(--panel);border:1px solid #1b222b;border-radius:14px;overflow:hidden}
    .card h2{font-size:1rem;font-weight:700;letter-spacing:.2px;margin:0;padding:.8rem .9rem;border-bottom:1px solid #1b222b}
    .card .body{padding:.9rem}
    .row{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
    button,select,input[type="text"],input[type="number"],textarea{background:#0f141a;border:1px solid #2a3441;color:var(--text);border-radius:10px;padding:.55rem .7rem;font:inherit}
    button{background:#18212b;cursor:pointer;transition:.15s ease}
    button:hover{background:#1d2733;border-color:#334152}
    .btn-primary{background:linear-gradient(180deg,#223344,#1a2836);border-color:#2b3a4b;color:#d7ecff}
    .btn-primary:hover{filter:brightness(1.07)}
    .btn-ghost{background:transparent;border-color:#2a3441}
    .small{font-size:.86rem;color:var(--muted)}
    .divider{height:1px;background:#1b222b;margin:.8rem 0}
    .grid2{display:grid;grid-template-columns:1fr;gap:.8rem}
    .npc-list{display:flex;flex-direction:column;gap:.5rem}
    .npc{display:flex;gap:.6rem;align-items:center;border:1px solid #1b222b;background:#0f141a;padding:.5rem;border-radius:12px}
    .npc img{width:40px;height:40px;object-fit:cover;border-radius:10px;border:1px solid #1b222b}
    .npc .name{font-weight:700}
    .npc .where{color:var(--muted);font-size:.85rem}
    .map{white-space:pre-wrap; line-height:1.65}
    .map a[data-goto], .map button.travel-link{
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.45rem .75rem; margin:.3rem .4rem .3rem 0;
      border:1px solid #2a3441; border-radius:999px;
      background:#0f141a; color:var(--text); text-decoration:none; cursor:pointer;
    }
    .map a[data-goto]:hover, .map button.travel-link:hover{
      background:#131a21; border-color:#3a4859; text-decoration:none;
    }
    #mapMedia{margin:0 0 .6rem 0}
    #locationImage{width:100%; height:220px; object-fit:cover; border:1px solid #1b222b; border-radius:10px; display:none}
    #sidebar h3{margin:.2rem 0 .3rem;font-size:.9rem;color:#cfd8e3}
    #knownChars .char{display:flex;align-items:center;gap:.45rem;padding:.3rem .4rem;border:1px solid #1b222b;background:#0f141a;border-radius:10px;margin:.25rem 0}
    #knownChars .char img{width:22px;height:22px;border-radius:6px;border:1px solid #1b222b}
    .known-list{display:flex;flex-direction:column; gap:.4rem; max-height:360px; overflow:auto}
    .known-item{display:flex; align-items:center; gap:.5rem; padding:.45rem .6rem; border:1px solid #1b222b; background:#0f141a; border-radius:10px; cursor:pointer}
    .known-item:hover{background:#131a21; border-color:#2a3441}
    .known-item img{width:28px; height:28px; border-radius:8px; border:1px solid #1b222b}
    .known-detail{background:#0f141a; border:1px solid #1b222b; border-radius:10px; padding:.7rem; min-height:240px}
    .fact{margin:.25rem 0; color:#d8e1ea}
    .player-card{display:flex; gap:.8rem; align-items:flex-start}
    .player-card img{width:96px;height:96px;border-radius:12px;border:1px solid #1b222b;object-fit:cover}
    .pc-name{font-weight:700; font-size:1.15rem; padding:.25rem .5rem; border:1px solid #2a3441; border-radius:999px; margin:.2rem .25rem .2rem 0; background:#0f141a;}

    /* Settings toggles effects */
    body.compact .card .body{ padding:.6rem }
    body.compact .layout{ gap:8px }
    body.contrast{ --panel:#0d1117; --text:#ffffff; --accent:#79c0ff }

    /* Chat modal must be readable + interactive */
    #chatModal { z-index: 3000; }
    #chatModal input#chatInput {
      background: #0f141a;      /* solid dark input background */
      color: var(--text);       /* visible text color */
      caret-color: var(--text);
  }
    #chatModal input#chatInput::placeholder { color: var(--muted); }

/* (safety) ensure clicks/typing aren't blocked */
    #chatModal, #chatModal * { pointer-events: auto; }
  
  .status-row{display:flex;align-items:center;gap:.5rem;margin:.25rem 0}
  .status-row .label{min-width:10rem}
  .light-dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#d33;box-shadow:0 0 0 1px rgba(0,0,0,.25);}
  .light-dot.ok{background:#17c964;}
  .light-dot.warn{background:#f5a623;}
</style>
</head>
<body>
  <header>
    <h1>AI NPC Game (Modular)</h1>
    <span class="pill">Location: <span id="loc">—</span></span>
    <span class="pill">Day: <span id="day">1</span></span>
    <span class="pill">Time: <span class="time-pill" id="time">morning</span></span>
    <span class="pill">Money: <span class="money" id="money">$50</span></span>
    <span style="margin-left:auto"></span>
    <button id="advance" class="btn-primary">Advance Time</button>
    <button id="openSettings" class="btn-ghost">Settings</button>
  </header>

  <main class="layout">
    <aside class="card" id="sidebar">
      <h2>Menu</h2>
      <div class="body">
        <h3>Your Info</h3>
        <div id="sidebarInfo" class="small">
          <p>Day: <span id="sidebarDay">1</span></p>
          <p>Time: <span id="sidebarTime">morning</span></p>
          <p>Money: <span id="sidebarMoney">$50</span></p>
        </div>

        <div class="divider"></div>
        <h3>Known Characters</h3>
        <div class="row" style="margin-top:.4rem; gap:.4rem;">
          <button id="openKnown" class="btn-ghost">View Known (<span id="knownCount">0</span>)</button>
        </div>

        <div class="divider"></div>
        <h3>Settings</h3>
        <div class="row" style="margin-top:.4rem; gap:.4rem;">
          <button id="openSettings2" class="btn-primary">Open Settings</button>
        </div>
      </div>
    </aside>

    <section class="card" id="mapCard">
      <h2>World</h2>
      <div class="body">
        <div id="mapMedia"><img id="locationImage" alt="Location image"></div>
        <div id="locationDesc" class="map">
          <b>No world loaded yet.</b><br/>
          Open <i>Settings → World & Characters</i> and load your <code>map.json</code> and <code>characters.json</code>.
        </div>
        <div class="divider"></div>
        <div class="small" style="margin:.3rem 0 .4rem;">Who's here</div>
        <div id="presence" class="small">—</div>
        <div id="hereNPCs" class="npc-list" style="margin-top:.4rem;"></div>
      </div>
    </section>

    <aside class="card" id="rightCard">
      <h2>Bag & Data</h2>
      <div class="body">
        <div class="grid2">
          <div>
            <div class="row">
              <input id="newItem" type="text" placeholder="Add item" />
              <button id="addItem">Add</button>
            </div>
            <div class="inventory-list" id="inv"></div>
            <div class="divider"></div>
            <div class="row">
              <input id="moneyDelta" type="number" step="1" placeholder="±$" style="width:90px" />
              <button id="applyMoney">Apply</button>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  
  <!-- Character Creation Modal -->
  <div id="charCreateModal" class="modal-overlay" aria-hidden="true" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:2200">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="charCreateTitle" style="width:min(920px,95vw);background:var(--panel);border:1px solid #1b222b;border-radius:14px;overflow:hidden">
      <header style="display:flex;align-items:center;gap:.6rem;padding:.7rem .9rem;border-bottom:1px solid #1b222b;background:#0f141a">
        <h3 id="charCreateTitle" style="margin:0;font-size:.98rem">Create Your Character</h3>
        <span class="small" style="opacity:.85;margin-left:.5rem;">You're 18, just finished high school, living with Mom & Sister.</span>
        <span style="margin-left:auto"></span>
        <button class="close" id="charCreateCloseBtn" title="Close" style="margin-left:auto;background:#222;border:1px solid #2a3441;border-radius:8px;padding:.25rem .5rem;cursor:pointer">×</button>
      </header>
      <div class="body" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;min-height:520px">
        <div>
          <label class="small">Name
            <input id="ccName" type="text" class="btn-ghost" placeholder="Your name…" style="width:100%"/>
          </label>
          <div class="divider"></div>
          <div class="small" style="margin-bottom:.35rem;">Sex / Gender</div>
          <div class="row">
            <label class="row"><input type="radio" name="ccGender" value="male" checked> Male</label>
            <label class="row"><input type="radio" name="ccGender" value="female"> Female</label>
            <label class="row"><input type="radio" name="ccGender" value="transgender"> Transgender</label>
          </div>
          <div class="divider"></div>

          <div class="small" style="margin-bottom:.35rem;">Preview</div>
          <div class="row" style="align-items:flex-start;gap:.6rem;">
            <img id="ccPreviewHead"  alt="Head"  style="width:80px;height:80px;object-fit:cover;border:1px solid #1b222b;border-radius:10px;background:#0f141a"/>
            <img id="ccPreviewTorso" alt="Torso" style="width:80px;height:80px;object-fit:cover;border:1px solid #1b222b;border-radius:10px;background:#0f141a"/>
            <img id="ccPreviewLegs"  alt="Legs"  style="width:80px;height:80px;object-fit:cover;border:1px solid #1b222b;border-radius:10px;background:#0f141a"/>
          </div>
          <div class="row" style="margin-top:.8rem;gap:.5rem;">
            <button id="ccSave" class="btn-primary">Save Character</button>
          </div>
        </div>
        <div>
          <div class="small" style="margin-bottom:.35rem;">Choose Head</div>
          <div id="ccHead" class="row" style="gap:.5rem;flex-wrap:wrap"></div>
          <div class="divider"></div>
          <div class="small" style="margin-bottom:.35rem;">Choose Torso</div>
          <div id="ccTorso" class="row" style="gap:.5rem;flex-wrap:wrap"></div>
          <div class="divider"></div>
          <div class="small" style="margin-bottom:.35rem;">Choose Legs</div>
          <div id="ccLegs" class="row" style="gap:.5rem;flex-wrap:wrap"></div>
        </div>
      </div>
    </div>
  </div>
<!-- Known Characters Modal -->
  <div id="knownModal" class="modal-overlay" aria-hidden="true" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:2000">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="knownTitle" style="width:min(900px,95vw);background:var(--panel);border:1px solid #1b222b;border-radius:14px;overflow:hidden">
      <header style="display:flex;align-items:center;gap:.6rem;padding:.7rem .9rem;border-bottom:1px solid #1b222b;background:#0f141a">
        <h3 id="knownTitle" style="margin:0;font-size:.98rem">Known Characters</h3>
        <span style="margin-left:auto"></span>
        <button class="close" id="knownCloseBtn" title="Close" style="margin-left:auto;background:#222;border:1px solid #2a3441;border-radius:8px;padding:.25rem .5rem;cursor:pointer">×</button>
      </header>
      <div class="body" style="display:grid;grid-template-columns:320px 1fr;gap:12px;min-height:520px">
        <div>
          <input id="knownSearch" class="btn-ghost" placeholder="Search…" style="width:100%;margin-bottom:.5rem"/>
          <div id="knownList" class="known-list"></div>
        </div>
        <div id="knownDetail" class="known-detail">Select a character</div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay" aria-hidden="true" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:2000">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" style="width:min(720px,95vw);background:var(--panel);border:1px solid #1b222b;border-radius:14px;overflow:hidden">
      <header style="display:flex;align-items:center;gap:.6rem;padding:.7rem .9rem;border-bottom:1px solid #1b222b;background:#0f141a">
        <h3 id="settingsTitle" style="margin:0;font-size:.98rem">Settings</h3>
        <span style="margin-left:auto"></span>
        <button class="close" id="settingsCloseBtn" title="Close" style="margin-left:auto;background:#222;border:1px solid #2a3441;border-radius:8px;padding:.25rem .5rem;cursor:pointer">×</button>
      </header>
      <div class="body">
        <label class="small">LLM API Key
          <input id="apiKey" type="text" class="btn-ghost" placeholder="Paste key…" style="width:100%"/>
        </label>

        <div class="divider"></div>

        <div class="grid2">
          <label class="row"><input type="checkbox" id="setCompact"> Compact UI</label>
          <label class="row"><input type="checkbox" id="setHighContrast"> High contrast</label>
        </div>

        <div class="divider"></div>

        <h3 class="small" style="margin:.25rem 0 .5rem 0;">World & Characters</h3>
<div class="status-row">
  <div class="label">WORLD.json</div>
  <div id="worldLight" class="light-dot" title="World load status"></div>
</div>
<div class="status-row">
  <div class="label">characters.json</div>
  <div id="charsLight" class="light-dot" title="Characters load status"></div>
</div>

<div class="row" style="gap:.75rem; flex-wrap:wrap; margin-top:.5rem;">
  <label class="btn-ghost" for="chubFile" title="Load a chub.ai character JSON">Load chub.ai character.json</label>
  <input id="chubFile" type="file" accept="application/json" style="display:none"/>
</div>
<div class="divider"></div>

        <h3 class="small" style="margin:.25rem 0 .5rem 0;">Game</h3>
        <div class="row" style="gap:.5rem;flex-wrap:wrap">
          <button id="saveGame" class="btn-ghost">Save Game</button>
          <button id="resetGame" class="btn-ghost">Reset Game</button>
          <button id="exportChatBtn" class="btn-ghost">Export Chat</button>
        
          <button id="exportChars" class="btn-ghost">Export Characters</button>
        </div>
        <div class="divider"></div>
        <h3 class="small" style="margin:.25rem 0 .5rem 0;">AI Tools</h3>
        <div class="row" style="gap:.5rem;flex-wrap:wrap">
          <button id="openCharBuilder" class="btn-primary">Character Builder</button>
        </div>

      </div>
    </div>
  </div>

  <!-- Character Builder Modal -->
  <div id="charBuildModal" class="modal-overlay" aria-hidden="true" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:2200">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="charBuildTitle" style="width:min(900px,95vw);background:var(--panel);border:1px solid #1b222b;border-radius:14px;overflow:hidden">
      <header style="display:flex;align-items:center;gap:.6rem;padding:.7rem .9rem;border-bottom:1px solid #1b222b;background:#0f141a">
        <h3 id="charBuildTitle" style="margin:0;font-size:.98rem">AI Character Builder</h3>
        <span id="charBuildStatus" class="small" style="margin-left:.6rem;opacity:.85;">Describe your character, then Generate.</span>
        <span style="margin-left:auto"></span>
        <button class="close" id="charBuildCloseBtn" title="Close" style="margin-left:auto;background:#222;border:1px solid #2a3441;border-radius:8px;padding:.25rem .5rem;cursor:pointer">×</button>
      </header>
      <div class="body" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;min-height:520px">
        <div>
          <div class="small" style="margin-bottom:.35rem;">Concept</div>
          <textarea id="charBuildPrompt" class="btn-ghost" placeholder="e.g., Warm-hearted coffee shop owner in her 40s, loves classic films, protective of regulars." style="width:100%;min-height:140px"></textarea>
          <div class="row" style="margin-top:.6rem; gap:.5rem;">
            <button id="charBuildGenerate" class="btn-primary">Generate with AI</button>
            <button id="charBuildCancel" class="btn-ghost">Cancel</button>
          </div>
        </div>
        <div>
          <div class="small" style="margin-bottom:.35rem;">Review / Edit JSON</div>
          <textarea id="charBuildJson" class="btn-ghost" placeholder="{ ... }" style="width:100%;min-height:360px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;"></textarea>
          <div class="row" style="margin-top:.6rem; gap:.5rem;">
            <button id="charBuildSave" class="btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<link rel="icon" href="./favicon.ico"> 
<script src="./src/cosmos.js"></script>

<script>
window.GameUI = window.GameUI || {};
if (!window.renderChat) { window.renderChat = function(){}; }
if (!window.GameUI.renderChat) { window.GameUI.renderChat = window.renderChat; }
if (!window.GameUI.startChat) { window.GameUI.startChat = function(n){ if (window.startChat) startChat(n); }; }
if (!window.GameUI.closeChat) { window.GameUI.closeChat = function(){ if (window.closeChatModal) closeChatModal(); }; }
if (!window.GameUI.sendCurrentMessage) { window.GameUI.sendCurrentMessage = function(){ if (window.sendCurrentMessage) window.sendCurrentMessage(); }; }
</script>
<script type="module" src="./chat/runtime.js?v=32"></script>
<script type="module" src="./src/main.js?v=21"></script> <!-- bump v to clear cache -->


</body>
</html>
